<!DOCTYPE html>
<html>
  <head>
    <title>SITIKAR Map</title>
    <meta name='viewport'
          content='width=device-width,initial-scale=1,maximum-scale=1' />
    <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.1/maps/maps.css'>
    <link rel='stylesheet' type='text/css' href='./UI/index.css'/>  <!--tampilan UI-->
    <link rel='stylesheet' type='text/css' href='./UI/routing.css'/>
    <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/plugins/SearchBox/3.2.0//SearchBox.css'/>
    <script src='https://api.tomtom.com/maps-sdk-for-web/cdn/plugins/SearchBox/3.2.0//SearchBox-web.js'></script>
    <link rel="stylesheet" type="text/css" href="https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.57.0/maps/css-styles/traffic-incidents.css" />
    <link rel="stylesheet" type="text/css" href="./UI/styles.css" />
    <style>
      .name {
        -webkit-box-orient: vertical;
            color: #262626;
            display: -webkit-box;
            font-family: "Gotham", Helvetica, Arial, sans-serif;
            font-size: 13px;
            font-weight: bold;
            -webkit-line-clamp: 2;
            margin-top: 8px;
            overflow: hidden;
            text-overflow: ellipsis
      }
      .category {
        color: #3f9cd9;
            font-family: "Gotham", Helvetica, Arial, sans-serif;
            font-size: 10px;
            font-weight: bold;
            margin-top: -10px;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
            white-space: nowrap;
      } 
      #foldable {
        width: 320px;
      }
      #form {
        margin-top: 10px;
      }
      .icon {
        background-size: cover;
        height: 30px;
        width: 30px;
      }
      .tt-icon-size {
        height: 18px !important;
        padding: 8px;
        width: 18px !important;
      }
      .icon-spacing-right {
        margin-right: 12px;
        margin-top: 22px;
      }
      .icon-spacing-left {
        margin-left: 12px;
        margin-top: 24px;
      }
      .tt-search-box-input {
        width: calc(100% - 25px) !important;
      }
      .searchbox-container {
        display: flex;
      }
      .searchbox-container > .tt-search-box {
        flex: 1;
        padding-right: 26px;
      }
      .my-location-button {
        background-image: url("https://api.tomtom.com/maps-sdk-for-web/cdn/static/my-location.svg");
        cursor: pointer;
        margin-left: 7px;
        padding: 12px;
      }
      .my-location-button:hover {
        background-image: url("https://api.tomtom.com/maps-sdk-for-web/cdn/static/my-location-hover.svg");
      }
      .route-marker {
        align-items: center;
        background-color: #4a90e2;
        border: solid 3px #2faaff;
        border-radius: 50%;
        display: flex;
        height: 32px;
        justify-content: center;
        transition: width .1s, height .1s;
        width: 32px;
      }
    </style>
  </head>
  <body>
    <script src='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.1/maps/maps-web.min.js'></script>
    <script src='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.1/services/services-web.min.js'></script>
    <script type='text/javascript' src='./js/formatters.js'></script>
    <script type='text/javascript' src='./js/info-hint.js'></script>
    <script type='text/javascript' src='./js/searchbox-enter-submit.js'></script>
    <script type='text/javascript' src='./js/foldable.js'></script>
    <script type='text/javascript' src='./js/tail.select.min.js'></script>

    <div id="map" style="width: 100%; height: 100%">
      <div id='foldable' class='tt-overlay-panel -left-top -medium js.foldable'>
        <form id=form>
          <div id="startSearchBox" class="searchbox-container">
            <div class="tt-icon tt-icon-size icon-spacing-right -start"></div>
          </div>
          <div id="finishSearchBox" class="searchbox-container">
            <div class="tt-icon tt-icon-size icon-spacing-right -finish"></div>
          </div>
        </form>
      </div>
      <!--sementara pake ini nanti diganti button right-bottom (masih gagal)-->
      <div id='foldable' class='tt-overlay-panel -right-top -medium js-foldable' style='width: 200px;'>
        <div class='tt-form'>
            <div class='tt-spacing-top-24'>
                <label class='tt-form-label'>Traffic layers</label>
                <input type='checkbox' class='tt-checkbox' id='incidents' checked='true'>
                <label class='tt-label' for="incidents">Incidents</label>
                <input type='checkbox' class='tt-checkbox' id='flow' checked='true'>
                <label class='tt-label' for="flow">Flow</label>
            </div>
        </div>
      </div> <!--end -->
    </div>
    

    <script>
      /*/* set marker kantor damkar*/
      let center=[107.6110212, -6.9215529] /*let = blok var = function*/
      let mako =  [107.63403662622008, -6.916781180397956]
      let utara = [107.59143622342704, -6.8774440161212835]
      let selatan = [107.58312626346968, -6.945680833473349]
      let timur = [107.67584301412951, -6.938258975278367]
      let barat = [107.57425747663765, -6.9082415715777215]
      
      var map = tt.map({
        key:"8dzxZD2SRE74hHUfz5Kg4DdW6KdNL859",
        container:"map",
        center:center,
        /*style: "https://api.tomtom.com/style/1/style/22.2.1-*?map=basic_main&poi=poi_dynamic",*/
        zoom:14,
        fadeDuration: 50,
        styleVisibility: {
          trafficIncidents: true,
          trafficFlow: true
        },
      }); /*const = sifatnya tetap tidak bisa di deklarasi ulang*/
      document.querySelector('#flow').addEventListener('change', function(event) {
        if (event.target.checked) {
            map.showTrafficFlow();
        } else {
            map.hideTrafficFlow();
        }
      });

      document.querySelector('#incidents').addEventListener('change', function(event) {
        if (event.target.checked) {
            map.showTrafficIncidents();
        } else {
            map.hideTrafficIncidents();
        }
      });
      
      

      /* load marker kantor damkar*/
      map.on('load', () => {
        new tt.Marker().setLngLat(mako).addTo(map)
        new tt.Marker().setLngLat(utara).addTo(map)
        new tt.Marker().setLngLat(selatan).addTo(map)
        new tt.Marker().setLngLat(timur).addTo(map)
        new tt.Marker().setLngLat(barat).addTo(map) 
      });
      
      new Foldable('#foldable', 'top-right');
      var bounds = new tt.LngLatBounds();

      var popup = null;
      var hoveredFeature = null;

      map.on('load', function() {
        bindMapEvents();
      });

      /*set POI pada maps*/
      function bindMapEvents() {
        map.on('click', function(event) {
          var feature  = map.queryRenderedFeatures(event.point)[0];
          hidePoiMarker();
  
          if (feature.sourceLayer === 'Point of Interest') {
            map.addLayer({
              'id': 'selectedPOI',
              'source': {
                'type': 'geojson',
                'data': {
                  'type': 'Feature',
                  'geometry': {
                    'type': 'Point',
                    'coordinates': feature.geometry.coordinates
                  }
                }
              },
              'type': 'symbol',
              'paint': {
                'text-color': 'rgba(0, 0, 0, 1)',
                'text-halo-color': 'rgba(255, 255, 255, 1)',
                'text-halo-width': 1
              },
              'layout': {
                'text-field': feature.properties.name || feature.properties.description,
                'icon-image': `${feature.properties.icon}_pin`,
                'icon-anchor': 'bottom',
                'text-letter-spacing': 0.1,
                'icon-padding': 5,
                'icon-offset': [0, 5],
                'text-max-width': 10,
                'text-variable-anchor': ['top'],
                'text-font': ['Noto-Bold'],
                'text-size': 14,
                'text-radial-offset': 0.2
              }
            });
          }
        });
        map.on('mouseenter', 'POI', function(event) {
          map.getCanvas().style.cursor = 'pointer';
          var feature = map.queryRenderedFeatures(event.point)[0];

          createPopup(feature);
          hoveredFeature = feature;

          map.setFeatureState(feature, { hover: true });
        });
  
        map.on('mouseleave', 'POI', function(event) {
          map.getCanvas().style.cursor ='';
          if (hoveredFeature) {
              map.setFeatureState(hoveredFeature, { hover: false });
          }
          hoveredFeature = null;
          if (!event.originalEvent.relatedTarget) {
              removePopup();
          }
        });
  
        map.on('click', 'POI', function(event) {
          map.getCanvas().style.cursor ='';
          if (hoveredFeature) {
              map.setFeatureState(hoveredFeature, { hover: false });
          }
          hoveredFeature = null;
          if (!event.originalEvent.relatedTarget) {
              removePopup();
          }
        });
      }
       /*set popup POI*/
      function createPopup(result) {
        var markerSize = 10;
        removePopup();
        
        var popupOffset = {
          'top': [0, markerSize],
            'top-left': [0, markerSize],
            'top-right': [0, markerSize],
            'bottom': [0, -markerSize],
            'bottom-left': [0, -markerSize],
            'bottom-right': [0, -markerSize],
            'left': [markerSize, -markerSize],
            'right': [-markerSize, -markerSize]
        };
        var htmlContent = document.createElement('div');

        htmlContent.innerHTML ='<div class="popup-container">'+'<div class="category">'+Formatters.formatCategoryName(result.properties.category)+'<div>'+'<div class="name">'+result.properties.name+'</div>'+'</div>';
    
        popup = new tt.Popup({ oofset: popupOffset })
          .setLngLat(result.geometry.coordinates)
          .setDOMContent(htmlContent)
          .addTo(map)
          .setMaxWidth('200px');

        htmlContent.addEventListener('mouseleave', function(){
          removePopup();
        });
      }
      /*menghapus popup POI*/
      function removePopup(){
        if (popup) {
          popup.remove();
          popup = null;
        }
      }
      /*hide POI agar tidak muncul*/
      function hidePoiMarker(){
        if (map.getLayer('selectedPOI')){
          map.removeLayer('selectedPOI');
          map.removeSource('selectedPOI');
        }
      }

      /*set Routing dari A ke B*/
      function RoutingAB(){
        this.state = {
          start: undefined,
          finish: undefined,
          marker: {
            start: undefined,
            finish: undefined
          }
        };
        this.startSearchbox = this.createSearchBox('start');
        this.createSearchBox('finish');

        this.closeButton = document.querySelector('.tt-search-box-close-icon');
        this.startSearchboxInput = this.startSearchbox.getSearchBoxHTML().querySelector('.tt-search-box-input');

        this.startSearchboxInput.addEventListener('input', this.handleSearchboxInputChange.bind(this));

        this.createMyLocationButton();
        this.switchToMyLocationButton();

        this.errorHint = new InfoHint('error', 'bottom-center', 5000).addTo(document.getElementById('map'));
      
      }
      /*set current location button*/
      RoutingAB.prototype.createMyLocationButton = function() {
        this.upperSearchboxIcon = document.createElement('div');
        this.upperSearchboxIcon.setAttribute('class', 'my-location-button');

        this.upperSearchboxIcon.addEventListener('click', function() {
          navigator.geolocation.getCurrentPosition(
            this.reverseGeocodeCurrentPosition.bind(this),
            this.handleError.bind(this)
          );
        }.bind(this));
      };

      /*set start search table dihandle function nya */
      RoutingAB.prototype.handleSearchboxInputChange = function(event) {
      var inputContent = event.target.value;

      if (inputContent.length > 0) {
        this.setCloseButton();
      } else {
          var resultList = this.startSearchbox.getSearchBoxHTML().querySelector('.tt-search-box-result-list');
            if (resultList || inputContent.length === 0) {
              return;
            }
            this.onResultCleared('start');
        }
      };
      /*set current position menadi start geocode*/
      RoutingAB.prototype.reverseGeocodeCurrentPosition = function(position) {
        this.state.start = [position.coords.longitude, position.coords.latitude];
        tt.services.reverseGeocode({
          key: '8dzxZD2SRE74hHUfz5Kg4DdW6KdNL859',
          position: this.state.start
        })
          .then(this.handleRevGeoResponse.bind(this))
          .catch(this.handleError.bind(this));
      };
      /*handle geo response dari current posisi awal menjadi address*/
      RoutingAB.prototype.handleRevGeoResponse = function(response) {
        var place = response.addresses[0];
        this.state.start = [place.position.lng, place.position.lat];
        this.startSearchbox.setValue(place.address.freeformAddress);
        this.onResultSelected(place, 'start');
      };
      /*melakukan perhitungan rute (nanti cari cara buat masukin astar atau fuzzy*/
      RoutingAB.prototype.calculateRoute = function() {
        if (map.getLayer('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }
        if (!this.state.start || !this.state.finish) {
          return;
        }
        this.errorHint.hide();
        var startPos = this.state.start.join(',');
        var finalPos = this.state.finish.join(',');

        tt.services.calculateRoute({
          key: '8dzxZD2SRE74hHUfz5Kg4DdW6KdNL859',
          traffic:true,
          locations: startPos + ':' + finalPos
        })
        .then(function(response) {
          var geojson = response.toGeoJson();
          map.addLayer({
            'id': 'route',
            'type': 'line',
            'source': {
              'type': 'geojson',
              'data': geojson
            },
            'paint': {
              'line-color': '#2faaff',
              'line-width': 8
            }
          }, this.findFirstBuildingLayerId());

          var coordinates = geojson.features[0].geometry.coordinates;
          this.updateRoutesBounds(coordinates);
        }.bind(this))
        .catch(this.handleError.bind(this));
      };
      /*handeling jika rute eror*/
      RoutingAB.prototype.handleError = function(error) {
        this.errorHint.setErrorMessage(error);
      };
      /*set draw line marker untuk rute*/
      RoutingAB.prototype.drawMarker = function(type, viewport) {
        if (this.state.marker[type]) {
            this.state.marker[type].remove();
        }

        var marker = document.createElement('div');
        var innerElement = document.createElement('div');

        marker.className = 'route-marker';
        innerElement.className = 'icon tt-icon -white -' + type;
        marker.appendChild(innerElement);

        this.state.marker[type] = new tt.Marker({ element: marker })
          .setLngLat(this.state[type])
          .addTo(map);

        this.updateBounds(viewport);
      };
      /*set simbol star n end dengan lokasi LnGLat start n end point */
      RoutingAB.prototype.updateBounds = function(viewport) {
        bounds = new tt.LngLatBounds();

        if (this.state.start) {
          bounds.extend(tt.LngLat.convert(this.state.start));
        }
        if (this.state.finish) {
          bounds.extend(tt.LngLat.convert(this.state.finish));
        }
        if (viewport) {
          bounds.extend(tt.LngLat.convert(viewport.topLeftPoint));
          bounds.extend(tt.LngLat.convert(viewport.btmRightPoint));
        }
        if (!bounds.isEmpty()) {
          map.fitBounds(bounds, { duration: 0, padding: 50 });
        }
      };
      /*set bounds? untuk set marker di LngLat yang dilewati??*/
      RoutingAB.prototype.updateRoutesBounds = function(coordinates) {
        bounds = new tt.LngLatBounds();
        coordinates.forEach(function(point) {
          bounds.extend(tt.LngLat.convert(point));
        });
        if (!bounds.isEmpty()) {
          map.fitBounds(bounds, { duration: 0, padding: 50 });
        }
      };
      /*create searcbox untuk set route*/
      RoutingAB.prototype.createSearchBox = function(type) {
        var searchBox = new tt.plugins.SearchBox(tt.services, {
          showSearchButton: false,
          searchOptions: {
            key: '8dzxZD2SRE74hHUfz5Kg4DdW6KdNL859'
          },
          labels: {
            placeholder: 'Query e.g. Washington'
          }
        });
        document.getElementById(type + 'SearchBox').appendChild(searchBox.getSearchBoxHTML());
        
        searchBox.on('tomtom.searchbox.resultsfound', function(event) {
          handleEnterSubmit(event, this.onResultSelected.bind(this), this.errorHint, type);
        }.bind(this));
        
        searchBox.on('tomtom.searchbox.resultselected', function(event) {
          if (event.data && event.data.result) {
            this.onResultSelected(event.data.result, type);
          }
        }.bind(this));
        searchBox.on('tomtom.searchbox.resultscleared', this.onResultCleared.bind(this, type));
        return searchBox;
      };
      /*set show hasil search address yang di pilih*/
      RoutingAB.prototype.onResultSelected = function(result, type) {
        var pos = result.position;
        this.state[type] = [pos.lng, pos.lat];

        if (type === 'start') {
          this.setCloseButton();
        }

        this.drawMarker(type, result.viewport);
        this.calculateRoute();
      };
      /*menghapus hasil searching*/
      RoutingAB.prototype.onResultCleared = function(type) {
        this.state[type] = undefined;

        if (this.state.marker[type]) {
          this.state.marker[type].remove();
          this.updateBounds();
        }
        if (type === 'start') {
          this.switchToMyLocationButton();
        }
        this.calculateRoute();
      };
      /*set close button pada searching lalu di hilangkan ketika searching undefined*/
      RoutingAB.prototype.setCloseButton = function() {
        var inputContainer = document.querySelector('.tt-search-box-input-container');
        this.closeButton.classList.remove('-hidden');

        if (document.querySelector('.my-location-button')) {
          inputContainer.replaceChild(this.closeButton, this.upperSearchboxIcon);
        }
      };
      /*show button current location*/
      RoutingAB.prototype.switchToMyLocationButton = function() {
        var inputContainer = document.querySelector('.tt-search-box-input-container');
        inputContainer.replaceChild(this.upperSearchboxIcon, this.closeButton);
      };
      /*layer route??*/
      RoutingAB.prototype.findFirstBuildingLayerId = function() {
        var layers = map.getStyle().layers;
        for (var index in layers) {
          if (layers[index].type === 'fill-extrusion') {
            return layers[index].id;
          }
        }
        throw new Error('Map style does not contain any layer with fill-extrusion type.');
      };
      new RoutingAB();

      /*copyright*/
      var attributions = [
        '<a class="tomtomAttribution">@SITIKAR</a>',
        '<a target="_blank" href="https://t.me/indraandriansyah">Laporkan</a>',
        '<a target="_blank" href="//www.tomtom.com/en_gb/legal/privacy/" id="privacy_link">Privacy</a>'
      ];
      map.getAttributionControl().addAttribution(attributions);
      
    </script>

  </body>
</html>